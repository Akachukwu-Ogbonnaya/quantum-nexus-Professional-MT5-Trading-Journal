{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">Platform Configuration</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert">Ã—</button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Connection Status - FIXED VERSION -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                MT5 Status:
                <span class="{{ 'text-success' if mt5_connected else 'text-danger' }}">
                    {{ 'Connected' if mt5_connected else 'Disconnected' }}
                </span>
            </h6>
        </div>
        <div class="card-body text-center">

            {% if mt5_connected %}
                <!-- DISCONNECT BUTTON - When connected -->
                <form method="POST" action="{{ url_for('configuration') }}" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="action" value="disconnect">
                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="fas fa-power-off"></i> Disconnect MT5
                    </button>
                </form>

                <!-- Connection Info -->
                <div class="mt-4">
                    <p class="text-success">
                        <i class="fas fa-check-circle"></i> Successfully Connected
                    </p>
                    {% if config %}
                        <p class="text-muted">
                            <i class="fas fa-server"></i> {{ config.get('mt5_server', 'Unknown') }} |
                            <i class="fas fa-user"></i> {{ config.get('mt5_login', 'Unknown') }}
                        </p>
                    {% endif %}
                </div>

            {% elif config and config.get('mt5_server') and config.get('mt5_login') %}
                <!-- PASSWORD FORM - When server settings exist but not connected -->
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-key"></i> Connect to MT5</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">
                                    <i class="fas fa-server"></i> {{ config.get('mt5_server', 'Unknown') }}<br>
                                    <i class="fas fa-user"></i> {{ config.get('mt5_login', 'Unknown') }}
                                </p>

                                <form method="POST" action="{{ url_for('configuration') }}">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" value="connect_with_password">

                                    <div class="mb-3">
                                        <label class="form-label">MT5 Password</label>
                                        <input type="password" class="form-control" name="password"
                                               placeholder="Enter your MT5 password" required>
                                    </div>

                                    <button type="submit" class="btn btn-success btn-block">
                                        <i class="fas fa-plug"></i> Connect to MT5
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            {% else %}
                <!-- FIRST TIME SETUP - When no server settings -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> First Time Setup</h5>
                    <p>Please configure your MT5 server and account settings first.</p>
                    <a href="#serverSettings" class="btn btn-primary">
                        <i class="fas fa-cog"></i> Configure Server Settings
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Server Settings Section -->
    <div class="card shadow mb-4" id="serverSettings">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-cog"></i> Server Settings
            </h6>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('configuration') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="save_settings">

                <div class="row">
                    <div class="col-md-6">
                        <!-- Server -->
                        <div class="mb-3">
                            <label class="form-label">MT5 Server *</label>
                            <input type="text" class="form-control" name="server"
                                   value="{{ config.get('mt5_server', '') if config else '' }}"
                                   placeholder="YourBroker-Server" required>
                            <small class="form-text text-muted">e.g., MetaQuotes-Demo, ICMarkets-Demo1</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Account Number -->
                        <div class="mb-3">
                            <label class="form-label">Account Number *</label>
                            <input type="number" class="form-control" name="account"
                                   value="{{ config.get('mt5_login', '') if config else '' }}"
                                   placeholder="1234567" required>
                        </div>
                    </div>
                </div>

                <!-- Terminal Path -->
                <div class="mb-3">
                    <label class="form-label">Terminal Path (Optional)</label>
                    <input type="text" class="form-control" name="terminal_path"
                           value="{{ config.get('terminal_path', '') if config else '' }}"
                           placeholder="C:/Program Files/MetaTrader 5/terminal64.exe">
                    <small class="form-text text-muted">Leave empty for auto-detection. Default: C:/Program Files/MetaTrader 5/terminal64.exe</small>
                </div>

                <!-- Test Connection Button -->
                <div class="mb-3">
                    <button type="button" id="testConnectionBtn" class="btn btn-info">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <small class="form-text text-muted">Test connection without saving</small>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Server Settings
                </button>
            </form>
        </div>
    </div>

    <!-- Connection Test Results -->
    <div id="testResult" class="alert" style="display: none;"></div>

    <!-- Quick Info -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-info-circle"></i> How to Connect
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="bg-primary text-white rounded-circle p-3 d-inline-block mb-2">
                            <i class="fas fa-cog fa-2x"></i>
                        </div>
                        <h6>1. Configure Server</h6>
                        <p class="small text-muted">Enter your MT5 server and account number</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="bg-success text-white rounded-circle p-3 d-inline-block mb-2">
                            <i class="fas fa-key fa-2x"></i>
                        </div>
                        <h6>2. Enter Password</h6>
                        <p class="small text-muted">Provide your MT5 password to connect</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="bg-info text-white rounded-circle p-3 d-inline-block mb-2">
                            <i class="fas fa-plug fa-2x"></i>
                        </div>
                        <h6>3. Start Trading</h6>
                        <p class="small text-muted">Access all MT5 features and analytics</p>
                    </div>
                </div>
            </div>

            <!-- Common Server Examples -->
            <div class="mt-4">
                <h6>Common MT5 Servers:</h6>
                <ul class="list-unstyled">
                    <li><strong>Demo Accounts:</strong> MetaQuotes-Demo, FXCM-MT5Demo, ICMarkets-Demo</li>
                    <li><strong>Live Accounts:</strong> Check with your broker for exact server name</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll to server settings
    const scrollLinks = document.querySelectorAll('a[href^="#"]');
    scrollLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        });
    });

    // Test Connection Functionality
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    if (testConnectionBtn) {
        testConnectionBtn.addEventListener('click', function() {
            const server = document.querySelector('input[name="server"]').value;
            const account = document.querySelector('input[name="account"]').value;
            const terminalPath = document.querySelector('input[name="terminal_path"]').value;

            if (!server || !account) {
                showTestResult('Please fill in Server and Account fields', 'danger');
                return;
            }

            // Show loading state
            testConnectionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            testConnectionBtn.disabled = true;

            // Send test request
            fetch('/api/test_connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'server': server,
                    'account': account,
                    'terminal_path': terminalPath,
                    'password': 'test' // Dummy password for testing
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTestResult(data.message, 'success');
                } else {
                    showTestResult(data.error || 'Connection failed', 'danger');
                }
            })
            .catch(error => {
                showTestResult('Connection test failed: ' + error, 'danger');
            })
            .finally(() => {
                // Reset button
                testConnectionBtn.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
                testConnectionBtn.disabled = false;
            });
        });
    }

    function showTestResult(message, type) {
        const resultDiv = document.getElementById('testResult');
        resultDiv.textContent = message;
        resultDiv.className = `alert alert-${type} alert-dismissible fade show`;
        resultDiv.style.display = 'block';

        // Auto-hide after 5 seconds
        setTimeout(() => {
            resultDiv.style.display = 'none';
        }, 5000);
    }

    console.log('Configuration page loaded successfully');
});
</script>
{% endblock %}