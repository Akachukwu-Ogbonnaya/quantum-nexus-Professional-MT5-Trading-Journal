{% extends "base.html" %}
{% block title %}Professional Trade Plan Manager{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 fw-bold text-primary mb-2">
            <i class="fas fa-chess-board me-2"></i>Trade Plan Manager
          </h1>
          <p class="text-muted mb-0">Strategize, execute, and analyze your trading performance with precision.</p>
        </div>
        <div class="text-end">
          <span class="badge bg-primary fs-6">Plans: {{ trade_plans|length }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50">Pending</h6>
              <h3 class="mb-0">{{ trade_plans|selectattr('status', 'equalto', 'pending')|list|length }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-clock fa-2x text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50">Executed</h6>
              <h3 class="mb-0">{{ trade_plans|selectattr('status', 'equalto', 'executed')|list|length }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-check-circle fa-2x text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card bg-warning text-dark h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title">Profitable</h6>
              <h3 class="mb-0">{{ trade_plans|selectattr('outcome', 'equalto', 'profit')|list|length }}</h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-chart-line fa-2x"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h6 class="card-title text-white-50">Success Rate</h6>
              <h3 class="mb-0">
                {% set executed_plans = trade_plans|selectattr('status', 'equalto', 'executed')|list %}
                {% set profitable_plans = trade_plans|selectattr('outcome', 'equalto', 'profit')|list %}
                {% if executed_plans|length > 0 %}
                  {{ ((profitable_plans|length / executed_plans|length) * 100)|round(1) }}%
                {% else %}
                  0%
                {% endif %}
              </h3>
            </div>
            <div class="align-self-center">
              <i class="fas fa-percentage fa-2x text-white-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- New Plan Form -->
<div class="card shadow-lg border-0 mb-5">
  <div class="card-header bg-gradient-primary text-white py-3">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-plus-circle me-2"></i>Create New Trade Plan
      </h5>
      <span class="badge bg-white text-primary">Strategic Planning</span>
    </div>
  </div>
  <div class="card-body p-4">
    <form method="POST" action="{{ url_for('trade_plan') }}">
      {{ form.hidden_tag() }}

      <!-- Basic Information -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <label class="form-label fw-semibold">Trading Pair *</label>
          <input name="symbol" type="text" class="form-control form-control-lg" placeholder="EURUSD" value="{{ request.form.symbol or '' }}" required>
          <div class="form-text">Enter the currency pair or symbol</div>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label fw-semibold">Trading Strategy *</label>
          <input name="strategy" type="text" class="form-control form-control-lg" placeholder="Breakout" value="{{ request.form.strategy or '' }}" required>
          <div class="form-text">e.g., Breakout, Pullback, Trend</div>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label fw-semibold">Timeframe *</label>
          <select class="form-select form-select-lg" name="timeframe" required>
            <option value="">Select Timeframe</option>
            <option value="1M" {% if request.form.timeframe == '1M' %}selected{% endif %}>1M</option>
            <option value="5M" {% if request.form.timeframe == '5M' %}selected{% endif %}>5M</option>
            <option value="15M" {% if request.form.timeframe == '15M' %}selected{% endif %}>15M</option>
            <option value="30M" {% if request.form.timeframe == '30M' %}selected{% endif %}>30M</option>
            <option value="1H" {% if request.form.timeframe == '1H' %}selected{% endif %}>1H</option>
            <option value="4H" {% if request.form.timeframe == '4H' %}selected{% endif %}>4H</option>
            <option value="Daily" {% if request.form.timeframe == 'Daily' %}selected{% endif %}>Daily</option>
            <option value="Weekly" {% if request.form.timeframe == 'Weekly' %}selected{% endif %}>Weekly</option>
          </select>
        </div>
        <div class="col-md-3 mb-3">
          <label class="form-label fw-semibold">Plan Date *</label>
          <input type="date" name="plan_date" class="form-control form-control-lg" value="{{ request.form.plan_date or current_date }}" required>
        </div>
      </div>

      <!-- Trading Conditions -->
      <div class="row mb-4">
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-sign-in-alt me-1"></i>Entry Conditions
          </label>
          <textarea name="entry_conditions" class="form-control" rows="3"
                    placeholder="Describe specific conditions for entry: price action, indicators, volume...">{{ request.form.entry_conditions or '' }}</textarea>
          <div class="form-text">Be specific about your entry criteria</div>
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">
            <i class="fas fa-sign-out-alt me-1"></i>Exit Conditions
          </label>
          <textarea name="exit_conditions" class="form-control" rows="3"
                    placeholder="Define exit strategy: TP levels, SL levels, trailing stops...">{{ request.form.exit_conditions or '' }}</textarea>
          <div class="form-text">Define your risk management strategy</div>
        </div>
      </div>

      <!-- Risk Management -->
      <div class="row mb-4">
        <div class="col-md-2 mb-3">
          <label class="form-label fw-semibold">Risk %</label>
          <div class="input-group input-group-lg">
            <input type="number" name="risk_percent" class="form-control" step="0.01" min="0.1" max="5"
                   placeholder="1.0" value="{{ request.form.risk_percent or '' }}">
            <span class="input-group-text">%</span>
          </div>
          <div class="form-text">Risk per trade (0.1-5%)</div>
        </div>
        <div class="col-md-2 mb-3">
          <label class="form-label fw-semibold">Reward %</label>
          <div class="input-group input-group-lg">
            <input type="number" name="reward_percent" class="form-control" step="0.01" min="0.1"
                   placeholder="2.0" value="{{ request.form.reward_percent or '' }}">
            <span class="input-group-text">%</span>
          </div>
          <div class="form-text">Expected reward</div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">Risk-Reward Ratio</label>
          <div class="form-control-plaintext fw-bold text-success fs-5">
            <span id="rrRatioDisplay">-</span>
          </div>
          <div class="form-text">Calculated automatically</div>
        </div>
        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">Plan Status *</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="status" id="pending" value="pending"
                   {% if not request.form.status or request.form.status == 'pending' %}checked{% endif %} required>
            <label class="btn btn-outline-warning" for="pending">
              <i class="fas fa-clock me-1"></i>Pending
            </label>

            <input type="radio" class="btn-check" name="status" id="executed" value="executed"
                   {% if request.form.status == 'executed' %}checked{% endif %}>
            <label class="btn btn-outline-success" for="executed">
              <i class="fas fa-play me-1"></i>Executed
            </label>

            <input type="radio" class="btn-check" name="status" id="cancelled" value="cancelled"
                   {% if request.form.status == 'cancelled' %}checked{% endif %}>
            <label class="btn btn-outline-danger" for="cancelled">
              <i class="fas fa-times me-1"></i>Cancelled
            </label>
          </div>
        </div>
      </div>

      <!-- Outcome Tracking -->
      <div class="row mb-4">
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Trade Outcome</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="outcome" id="profit" value="profit"
                   {% if request.form.outcome == 'profit' %}checked{% endif %}>
            <label class="btn btn-outline-success" for="profit">
              <i class="fas fa-trophy me-1"></i>Profit
            </label>

            <input type="radio" class="btn-check" name="outcome" id="loss" value="loss"
                   {% if request.form.outcome == 'loss' %}checked{% endif %}>
            <label class="btn btn-outline-danger" for="loss">
              <i class="fas fa-times me-1"></i>Loss
            </label>

            <input type="radio" class="btn-check" name="outcome" id="breakeven" value="breakeven"
                   {% if request.form.outcome == 'breakeven' %}checked{% endif %}>
            <label class="btn btn-outline-secondary" for="breakeven">
              <i class="fas fa-minus me-1"></i>Breakeven
            </label>
          </div>
        </div>
        <div class="col-md-6 mb-3 d-flex align-items-end">
          <div class="text-end w-100">
            <button type="submit" class="btn btn-primary btn-lg px-5">
              <i class="fas fa-save me-2"></i>Save Trade Plan
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

  <!-- Plans Table -->
  <div class="card shadow-lg border-0">
    <div class="card-header bg-light py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold text-dark">
          <i class="fas fa-list-alt me-2"></i>Trade Plans History
        </h5>
        <span class="badge bg-primary fs-6">{{ trade_plans|length }} total plans</span>
      </div>
    </div>
    <div class="card-body p-0">
      {% if trade_plans %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-primary">
            <tr>
              <th class="ps-4">#</th>
              <th>Pair</th>
              <th>Strategy</th>
              <th>Timeframe</th>
              <th>Risk %</th>
              <th>Reward %</th>
              <th>R:R</th>
              <th>Status</th>
              <th>Outcome</th>
              <th>Date</th>
              <th class="text-end pe-4">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for plan in trade_plans %}
            <tr class="{% if plan.status == 'executed' and plan.outcome == 'profit' %}table-success{% elif plan.status == 'executed' and plan.outcome == 'loss' %}table-danger{% endif %}">
              <td class="ps-4 fw-bold">{{ loop.index }}</td>
              <td>
                <span class="fw-bold text-dark">{{ plan.symbol or 'N/A' }}</span>
              </td>
              <td>
                <span class="badge bg-info text-dark">{{ plan.strategy or 'N/A' }}</span>
              </td>
              <td>
                <small class="text-muted">{{ plan.timeframe or 'N/A' }}</small>
              </td>
              <td>
                <span class="fw-semibold {% if plan.risk_percent and plan.risk_percent > 2 %}text-danger{% else %}text-dark{% endif %}">
                  {{ plan.risk_percent or '0' }}%
                </span>
              </td>
              <td>
                <span class="fw-semibold text-success">{{ plan.reward_percent or '0' }}%</span>
              </td>
              <td>
                {% if plan.risk_percent and plan.reward_percent and plan.risk_percent > 0 %}
                  <span class="badge {% if (plan.reward_percent / plan.risk_percent) >= 2 %}bg-success{% else %}bg-warning text-dark{% endif %}">
                    {{ "%.2f"|format(plan.reward_percent / plan.risk_percent) }}:1
                  </span>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if plan.status == 'pending' %}
                  <span class="badge bg-warning text-dark">
                    <i class="fas fa-clock me-1"></i>Pending
                  </span>
                {% elif plan.status == 'executed' %}
                  <span class="badge bg-success">
                    <i class="fas fa-check me-1"></i>Executed
                  </span>
                {% elif plan.status == 'cancelled' %}
                  <span class="badge bg-danger">
                    <i class="fas fa-times me-1"></i>Cancelled
                  </span>
                {% else %}
                  <span class="badge bg-secondary">
                    <i class="fas fa-question me-1"></i>Unknown
                  </span>
                {% endif %}
              </td>
              <td>
                {% if plan.outcome == 'profit' %}
                  <span class="badge bg-success">
                    <i class="fas fa-trophy me-1"></i>Profit
                  </span>
                {% elif plan.outcome == 'loss' %}
                  <span class="badge bg-danger">
                    <i class="fas fa-times me-1"></i>Loss
                  </span>
                {% elif plan.outcome == 'breakeven' %}
                  <span class="badge bg-secondary">
                    <i class="fas fa-minus me-1"></i>Breakeven
                  </span>
                {% else %}
                  <span class="badge bg-light text-dark">
                    <i class="fas fa-minus me-1"></i>Not Set
                  </span>
                {% endif %}
              </td>
              <td>
                <small class="text-muted">{{ plan.plan_date or 'N/A' }}</small>
              </td>
              <td class="text-end pe-4">
                <div class="btn-group btn-group-sm">
                  <button class="btn btn-outline-primary" data-bs-toggle="modal"
                          data-bs-target="#editPlanModal{{ plan.id }}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <a href="{{ url_for('delete_trade_plan', plan_id=plan.id) }}"
                     class="btn btn-outline-danger"
                     onclick="return confirm('Are you sure you want to delete this trade plan?')">
                    <i class="fas fa-trash"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
        <h5 class="text-muted">No Trade Plans Yet</h5>
        <p class="text-muted">Create your first trade plan to get started with strategic trading.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- JavaScript for R:R Calculation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const riskInput = document.querySelector('input[name="risk_percent"]');
  const rewardInput = document.querySelector('input[name="reward_percent"]');
  const rrDisplay = document.getElementById('rrRatioDisplay');

  function calculateRR() {
    const risk = parseFloat(riskInput.value) || 0;
    const reward = parseFloat(rewardInput.value) || 0;

    if (risk > 0 && reward > 0) {
      const ratio = (reward / risk).toFixed(2);
      rrDisplay.textContent = ratio + ':1';
      rrDisplay.className = 'form-control-plaintext fw-bold ' +
        (ratio >= 2 ? 'text-success' : ratio >= 1 ? 'text-warning' : 'text-danger') + ' fs-5';
    } else {
      rrDisplay.textContent = '-';
      rrDisplay.className = 'form-control-plaintext fw-bold text-muted fs-5';
    }
  }

  riskInput.addEventListener('input', calculateRR);
  rewardInput.addEventListener('input', calculateRR);
});
</script>

<!-- Edit Modals with Complete Form Structure -->
{% for plan in trade_plans %}
<!-- Edit Modal for {{ plan.id }} -->
<div class="modal fade" id="editPlanModal{{ plan.id }}" tabindex="-1" aria-labelledby="editPlanModalLabel{{ plan.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editPlanModalLabel{{ plan.id }}">
          <i class="fas fa-edit me-2"></i>Edit Trade Plan #{{ plan.id }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('edit_trade_plan', plan_id=plan.id) }}">
        {{ form.hidden_tag() }}
        <div class="modal-body">
          <!-- Basic Information -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3">
              <label class="form-label fw-semibold">Trading Pair *</label>
              <input name="symbol" type="text" class="form-control form-control-lg"
                     value="{{ plan.symbol or '' }}" required>
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label fw-semibold">Trading Strategy *</label>
              <input name="strategy" type="text" class="form-control form-control-lg"
                     value="{{ plan.strategy or '' }}" required>
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label fw-semibold">Timeframe *</label>
              <select class="form-select form-select-lg" name="timeframe" required>
                <option value="">Select Timeframe</option>
                <option value="1M" {% if plan.timeframe == '1M' %}selected{% endif %}>1M</option>
                <option value="5M" {% if plan.timeframe == '5M' %}selected{% endif %}>5M</option>
                <option value="15M" {% if plan.timeframe == '15M' %}selected{% endif %}>15M</option>
                <option value="30M" {% if plan.timeframe == '30M' %}selected{% endif %}>30M</option>
                <option value="1H" {% if plan.timeframe == '1H' %}selected{% endif %}>1H</option>
                <option value="4H" {% if plan.timeframe == '4H' %}selected{% endif %}>4H</option>
                <option value="Daily" {% if plan.timeframe == 'Daily' %}selected{% endif %}>Daily</option>
                <option value="Weekly" {% if plan.timeframe == 'Weekly' %}selected{% endif %}>Weekly</option>
              </select>
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label fw-semibold">Plan Date *</label>
              <input type="date" name="plan_date" class="form-control form-control-lg"
                     value="{{ plan.plan_date or '' }}" required>
            </div>
          </div>

          <!-- Trading Conditions -->
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">
                <i class="fas fa-sign-in-alt me-1"></i>Entry Conditions
              </label>
              <textarea name="entry_conditions" class="form-control" rows="3">{{ plan.entry_conditions or '' }}</textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">
                <i class="fas fa-sign-out-alt me-1"></i>Exit Conditions
              </label>
              <textarea name="exit_conditions" class="form-control" rows="3">{{ plan.exit_conditions or '' }}</textarea>
            </div>
          </div>

          <!-- Risk Management -->
          <div class="row mb-4">
            <div class="col-md-2 mb-3">
              <label class="form-label fw-semibold">Risk %</label>
              <div class="input-group input-group-lg">
                <input type="number" name="risk_percent" class="form-control" step="0.01" min="0.1" max="5"
                       value="{{ plan.risk_percent or '' }}">
                <span class="input-group-text">%</span>
              </div>
            </div>
            <div class="col-md-2 mb-3">
              <label class="form-label fw-semibold">Reward %</label>
              <div class="input-group input-group-lg">
                <input type="number" name="reward_percent" class="form-control" step="0.01" min="0.1"
                       value="{{ plan.reward_percent or '' }}">
                <span class="input-group-text">%</span>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">Risk-Reward Ratio</label>
              <div class="form-control-plaintext fw-bold text-success fs-5">
                {% if plan.risk_percent and plan.reward_percent and plan.risk_percent > 0 %}
                  <span>{{ "%.2f"|format(plan.reward_percent / plan.risk_percent) }}:1</span>
                {% else %}
                  <span>-</span>
                {% endif %}
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label fw-semibold">Plan Status *</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="status" id="edit_pending{{ plan.id }}" value="pending"
                       {% if plan.status == 'pending' %}checked{% endif %} required>
                <label class="btn btn-outline-warning" for="edit_pending{{ plan.id }}">
                  <i class="fas fa-clock me-1"></i>Pending
                </label>

                <input type="radio" class="btn-check" name="status" id="edit_executed{{ plan.id }}" value="executed"
                       {% if plan.status == 'executed' %}checked{% endif %}>
                <label class="btn btn-outline-success" for="edit_executed{{ plan.id }}">
                  <i class="fas fa-play me-1"></i>Executed
                </label>

                <input type="radio" class="btn-check" name="status" id="edit_cancelled{{ plan.id }}" value="cancelled"
                       {% if plan.status == 'cancelled' %}checked{% endif %}>
                <label class="btn btn-outline-danger" for="edit_cancelled{{ plan.id }}">
                  <i class="fas fa-times me-1"></i>Cancelled
                </label>
              </div>
            </div>
          </div>

          <!-- Outcome Tracking -->
          <div class="row mb-4">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Trade Outcome</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="outcome" id="edit_profit{{ plan.id }}" value="profit"
                       {% if plan.outcome == 'profit' %}checked{% endif %}>
                <label class="btn btn-outline-success" for="edit_profit{{ plan.id }}">
                  <i class="fas fa-trophy me-1"></i>Profit
                </label>

                <input type="radio" class="btn-check" name="outcome" id="edit_loss{{ plan.id }}" value="loss"
                       {% if plan.outcome == 'loss' %}checked{% endif %}>
                <label class="btn btn-outline-danger" for="edit_loss{{ plan.id }}">
                  <i class="fas fa-times me-1"></i>Loss
                </label>

                <input type="radio" class="btn-check" name="outcome" id="edit_breakeven{{ plan.id }}" value="breakeven"
                       {% if plan.outcome == 'breakeven' %}checked{% endif %}>
                <label class="btn btn-outline-secondary" for="edit_breakeven{{ plan.id }}">
                  <i class="fas fa-minus me-1"></i>Breakeven
                </label>

                <input type="radio" class="btn-check" name="outcome" id="edit_none{{ plan.id }}" value=""
                       {% if not plan.outcome %}checked{% endif %}>
                <label class="btn btn-outline-light text-dark" for="edit_none{{ plan.id }}">
                  <i class="fas fa-ban me-1"></i>None
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}