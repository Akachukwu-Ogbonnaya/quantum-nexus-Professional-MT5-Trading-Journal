{% extends "base.html" %}

{% block title %}Trend Analysis - Professional MT5 Journal{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-chart-line text-success me-2"></i>Trend Analysis Dashboard
            {% if is_demo_mode %}
            <span class="badge bg-warning ms-2">Demo Mode</span>
            {% else %}
            <span class="badge bg-success ms-2">Live MT5</span>
            {% endif %}
        </h1>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="periodDropdown" data-bs-toggle="dropdown">
                <i class="fas fa-calendar me-2"></i>{{ current_period|default('All Time', true)|title }}
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?period=daily">Daily</a></li>
                <li><a class="dropdown-item" href="?period=weekly">Weekly</a></li>
                <li><a class="dropdown-item" href="?period=monthly">Monthly</a></li>
                <li><a class="dropdown-item" href="?period=3months">3 Months</a></li>
                <li><a class="dropdown-item" href="?period=6months">6 Months</a></li>
                <li><a class="dropdown-item" href="?period=1year">1 Year</a></li>
                <li><a class="dropdown-item" href="?period=all">All Time</a></li>
            </ul>
        </div>
    </div>

    <!-- Demo Mode Alert -->
    {% if is_demo_mode %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Demo Mode Active:</strong> Showing simulated trend analysis data. Connect to live MT5 for real trading trends.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Trend Score Cards -->
    <div class="row mb-4">
        <!-- Equity Trend -->
        <div class="col-xl-3 col-md-6 mb-4">
           <div class="card border-left-{{ 'success' if trend_metrics['consistency_score'] > 70 else 'warning' if trend_metrics['consistency_score'] > 40 else 'danger' }} shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-{{ 'success' if trend_metrics.equity_trend > 0 else 'danger' }} text-uppercase mb-1">
                                Equity Trend
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "%+.2f"|format(trend_metrics.equity_trend) }}%
                            </div>
                            <div class="text-xs text-muted mt-1">
                                {{ trend_metrics.equity_trend_strength|default('Moderate', true) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-{{ 'chart-line-up' if trend_metrics.equity_trend > 0 else 'chart-line-down' }} fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Consistency -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-{{ 'success' if trend_metrics.consistency_score > 70 else 'warning' if trend_metrics.consistency_score > 40 else 'danger' }} shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-{{ 'success' if trend_metrics.consistency_score > 70 else 'warning' if trend_metrics.consistency_score > 40 else 'danger' }} text-uppercase mb-1">
                                Consistency Score
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "%.1f"|format(trend_metrics.consistency_score) }}/100
                            </div>
                            <div class="text-xs text-muted mt-1">
                                Performance Stability
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bullseye fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Win Streak Analysis -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-{{ 'success' if trend_metrics.current_streak > 0 else 'danger' }} shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-{{ 'success' if trend_metrics.current_streak > 0 else 'danger' }} text-uppercase mb-1">
                                Current Streak
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ trend_metrics['current_streak'] }} {{ 'Wins' if trend_metrics.current_streak > 0 else 'Losses' }}
                            </div>
                            <div class="text-xs text-muted mt-1">
                                {{ trend_metrics.streak_trend|default('Neutral', true) }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-{{ 'fire' if trend_metrics.current_streak > 2 else 'bolt' if trend_metrics.current_streak != 0 else 'pause' }} fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trend Momentum -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-{{ 'success' if trend_metrics.momentum_score > 50 else 'warning' if trend_metrics.momentum_score > 0 else 'danger' }} shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-{{ 'success' if trend_metrics.momentum_score > 50 else 'warning' if trend_metrics.momentum_score > 0 else 'danger' }} text-uppercase mb-1">
                                Trend Momentum
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "%.1f"|format(trend_metrics.momentum_score) }}/100
                            </div>
                            <div class="text-xs text-muted mt-1">
                                Direction Strength
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tachometer-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Charts Row -->
    <div class="row">
        <!-- Equity Curve with Trend -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Equity Curve with Trend Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="equityTrendChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Trends -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Performance Trends</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="performanceTrendChart" width="400" height="200"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2">
                            <i class="fas fa-circle text-success"></i> Uptrend
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-warning"></i> Sideways
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-danger"></i> Downtrend
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Charts -->
    <div class="row">
        <!-- Monthly Performance Trend -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Monthly Performance Trend</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="monthlyTrendChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Win/Loss Pattern -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Win/Loss Pattern Analysis</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="patternChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trend Insights -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Trend Insights & Predictions</h6>
                    <span class="badge bg-{{ 'success' if trend_insights.overall_outlook == 'Bullish' else 'danger' if trend_insights.overall_outlook == 'Bearish' else 'warning' }}">
                        {{ trend_insights.overall_outlook|default('Neutral', true) }} Outlook
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for insight in trend_insights.insights %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-{{ 'success' if insight.sentiment == 'positive' else 'danger' if insight.sentiment == 'negative' else 'warning' }}">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-{{ 'check-circle' if insight.sentiment == 'positive' else 'exclamation-triangle' if insight.sentiment == 'negative' else 'info-circle' }} text-{{ 'success' if insight.sentiment == 'positive' else 'danger' if insight.sentiment == 'negative' else 'warning' }} me-2"></i>
                                        {{ insight['title'] }}
                                    </h6>
                                    <p class="card-text small">{{ insight['description'] }}</p>
                                    {% if insight.recommendation %}
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <strong>Recommendation:</strong> {{ insight['recommendation'] }}
                                        </small>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center text-muted">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <p>No trend insights available in demo mode. Connect to live MT5 for detailed analysis.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Safe data extraction with fallbacks
const equityDates = {{ equity_trend_data['dates']|tojson if equity_trend_data and 'dates' in equity_trend_data else ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'] }};
const equityValues = {{ equity_trend_data['equity']|tojson if equity_trend_data and 'equity' in equity_trend_data else [10000, 10200, 10150, 10300, 10450, 10380, 10520] }};
const trendLineValues = {{ equity_trend_data.trend_line|tojson if equity_trend_data and equity_trend_data.trend_line else [10000, 10100, 10200, 10300, 10400, 10500, 10600] }};
const trendDistribution = {{ trend_distribution|tojson if trend_distribution else [60, 25, 15] }};
const monthlyMonths = {{ monthly_trend_data.months|tojson if monthly_trend_data and monthly_trend_data.months else ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'] }};
const monthlyPnl = {{ monthly_trend_data.pnl|tojson if monthly_trend_data and monthly_trend_data.pnl else [1200, -450, 800, 1500, 900, 1100] }};
const monthlyColors = {{ monthly_trend_data.colors|tojson if monthly_trend_data and monthly_trend_data.colors else ['#1cc88a', '#e74a3b', '#1cc88a', '#1cc88a', '#1cc88a', '#1cc88a'] }};
const patternSequence = {{ pattern_data.sequence|tojson if pattern_data and pattern_data.sequence else [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] }};
const patternValues = {{ pattern_data['values']|tojson if pattern_data and 'values' in pattern_data else [1, -1, 1, 1, -1, 1, -1, -1, 1, 1] }};
const patternPointColors = {{ pattern_data.point_colors|tojson if pattern_data and pattern_data.point_colors else ['#1cc88a', '#e74a3b', '#1cc88a', '#1cc88a', '#e74a3b', '#1cc88a', '#e74a3b', '#e74a3b', '#1cc88a', '#1cc88a'] }};

// Equity Trend Chart
const equityTrendCtx = document.getElementById('equityTrendChart').getContext('2d');
const equityTrendChart = new Chart(equityTrendCtx, {
    type: 'line',
    data: {
        labels: equityDates,
        datasets: [{
            label: 'Equity Curve',
            data: equityValues,
            borderColor: 'rgba(78, 115, 223, 1)',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            fill: true,
            tension: 0.4
        }, {
            label: 'Trend Line',
            data: trendLineValues,
            borderColor: 'rgba(231, 74, 59, 1)',
            borderDash: [5, 5],
            fill: false,
            pointRadius: 0
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                title: {
                    display: true,
                    text: 'Equity ($)'
                }
            }
        }
    }
});

// Performance Trend Chart
const performanceTrendCtx = document.getElementById('performanceTrendChart').getContext('2d');
const performanceTrendChart = new Chart(performanceTrendCtx, {
    type: 'doughnut',
    data: {
        labels: ['Uptrend Periods', 'Sideways Periods', 'Downtrend Periods'],
        datasets: [{
            data: trendDistribution,
            backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
            hoverBackgroundColor: ['#17a673', '#dda20a', '#be2617'],
            hoverBorderColor: "rgba(234, 236, 244, 1)",
        }]
    },
    options: {
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        cutout: '70%',
    }
});

// Monthly Trend Chart
const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
const monthlyTrendChart = new Chart(monthlyTrendCtx, {
    type: 'bar',
    data: {
        labels: monthlyMonths,
        datasets: [{
            label: 'Monthly PnL',
            data: monthlyPnl,
            backgroundColor: monthlyColors,
            borderColor: 'rgba(78, 115, 223, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                title: {
                    display: true,
                    text: 'Profit/Loss ($)'
                }
            }
        }
    }
});

// Pattern Chart
const patternCtx = document.getElementById('patternChart').getContext('2d');
const patternChart = new Chart(patternCtx, {
    type: 'line',
    data: {
        labels: patternSequence,
        datasets: [{
            label: 'Win/Loss Pattern',
            data: patternValues,
            borderColor: 'rgba(120, 96, 222, 1)',
            backgroundColor: 'rgba(120, 96, 222, 0.1)',
            fill: true,
            tension: 0.4,
            pointBackgroundColor: patternPointColors
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                display: false
            }
        }
    }
});

// Auto-refresh for live data
{% if not is_demo_mode %}
setInterval(() => {
    fetch('/api/trend_metrics')
        .then(response => response.json())
        .then(data => {
            // Update charts with live data
            console.log('Live trend data updated:', data);
        })
        .catch(error => {
            console.log('Live data update failed, staying in current state');
        });
}, 30000); // Update every 30 seconds
// =============================================================================
// AUTO-CONNECTION STATUS DETECTION (ADD THIS AT THE END)
// =============================================================================

// Auto-detect connection status changes
function checkConnectionStatus() {
    fetch('/api/connection_status')
        .then(response => response.json())
        .then(data => {
            const currentDemoMode = {{ is_demo_mode|tojson }};

            // If status changed, show notification and optionally reload
            if (data.is_demo_mode !== currentDemoMode) {
                showConnectionChangeNotification(data.status);

                // Optional: Auto-refresh page when connection status changes
                if ({{ auto_refresh|default(false)|tojson }}) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                }
            }
        })
        .catch(error => {
            console.log('Connection status check failed:', error);
        });
}

function showConnectionChangeNotification(newStatus) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${newStatus === 'live' ? 'success' : 'warning'} alert-dismissible fade show`;
    notification.innerHTML = `
        <i class="fas fa-${newStatus === 'live' ? 'plug' : 'unplug'} me-2"></i>
        <strong>Connection Status Changed:</strong> Now in ${newStatus.toUpperCase()} mode
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at top of page
    const container = document.querySelector('.container-fluid');
    container.insertBefore(notification, container.firstChild);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Check connection status every 30 seconds
setInterval(checkConnectionStatus, 30000);

// Initial check when page loads
document.addEventListener('DOMContentLoaded', function() {
    checkConnectionStatus();
});
{% endif %}
{% endblock %}